<!DOCTYPE = html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Shoehorn Circle - Game Finder</title>
    </head>
    <body>
        <h1>Join a Game</h1>

        <form id="f1">
            <input type="text" name="gname"/>
            <input type="submit" value="Create a Game"/>
        </form>
        <div id="gamelist">
        </div>

    <script src="/util.js"></script>
    <script>

let username = getCookie("user_name");

function formdata(f){
    let res = {};
    for (p in f.children){
        elem = f.children[p];
        console.log(elem.nodeName);
        if (elem.nodeName !== "INPUT") continue;
        if (elem.type == "submit") continue;
        res[elem.name]=elem.value;
        console.log("V = "+elem.name + " "  + elem.value);
    }
    return res;
}

let f1 = document.getElementById("f1");
f1.onsubmit= function(e){

    data = formdata(f1);
    console.log(data);
    game_joiner(data.gname)();
    return false;
}

function game_joiner(gname){
    return function(){
        fetch("/join_game",{
            method:"POST",
            headers:{
                "Content-Type":"application/json"
            },
            body:JSON.stringify(gname)
        }).then(response => response.json())
            .catch(e=>console.log("Hello Error:"+ e))
            .then(res=> showGameList(res));
    }
}

function leave_game(){
    fetch("/leave_game",{
        method:"POST",
        headers:{
            "Content-Type":"application/json"
        },
    }).then(response => response.json())
        .catch(e=>console.log("Hello Error:"+ e))
        .then(res=> showGameList(res));

}



function showGameList(d){
    let gameList = document.getElementById("gamelist");
    gameList.innerHTML = "";
    for( p in d){
        let gm = d[p];
        let gbox = document.createElement("div"); 
        let nm = document.createTextNode(gm.name+":");
        gbox.appendChild(nm);

        let has_user = -1;
        
        for (q in gm.players){
            let pname = gm.players[q];
            if (pname === username)has_user = q;
            let namenode= document.createTextNode(pname+",");
            gbox.appendChild(namenode);
        }
        
        if ((has_user == 0 )&&(gm.players.length > 1)){ //is leader
            let bbutt = document.createElement("button");
            //TODO add function
            bbutt.innerHTML = "Begin";
            gbox.appendChild(bbutt);
        }
        
        if (has_user >= 0){ //is member
            let lbutt = document.createElement("button");
            lbutt.onclick = leave_game;
            lbutt.innerHTML = "Leave";
            gbox.appendChild(lbutt);
        }else{
            let jbutt = document.createElement("button");
            jbutt.onclick = game_joiner(gm.name);
            jbutt.innerHTML="Join";
            gbox.appendChild(jbutt);
        }

        gameList.appendChild(gbox);
    }
}


getGameList = function(){
    fetch("/view_games",{
        method:"GET",
        headers:{
            "Content-Type":"application/json"
        },
    }).then(response => response.json())
        .catch(e=>console.log("View Error:"+ e))
        .then(res=> showGameList(res));
}

onload = getGameList;
setInterval(getGameList,5000);



    </script>


    </body>
</html>
